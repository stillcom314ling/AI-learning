name: Unity Build

on:
  push:
    branches:
      - main
      - 'claude/**'
    paths:
      - 'Unity project/**'
      - '.github/workflows/unity-build.yml'
  pull_request:
    branches:
      - main
    paths:
      - 'Unity project/**'
      - '.github/workflows/unity-build.yml'
  workflow_dispatch:
    inputs:
      build_android:
        description: 'Build for Android'
        type: boolean
        default: true
      build_webgl:
        description: 'Build for WebGL'
        type: boolean
        default: true

env:
  UNITY_PROJECT_PATH: Unity project

jobs:
  # Check for Unity license secret
  check-license:
    name: Check License
    runs-on: ubuntu-latest
    outputs:
      has-license: ${{ steps.check.outputs.has-license }}
    steps:
      - name: Check for Unity License
        id: check
        run: |
          if [ -n "${{ secrets.UNITY_LICENSE }}" ]; then
            echo "has-license=true" >> $GITHUB_OUTPUT
          else
            echo "has-license=false" >> $GITHUB_OUTPUT
            echo "::warning::UNITY_LICENSE secret is not set. Builds will be skipped."
            echo "To enable builds, add your Unity license file content as a secret named UNITY_LICENSE."
            echo "See: https://game.ci/docs/github/activation"
          fi

  # Build for Android
  build-android:
    name: Build Android
    runs-on: ubuntu-latest
    needs: check-license
    if: |
      needs.check-license.outputs.has-license == 'true' &&
      (github.event_name != 'workflow_dispatch' || inputs.build_android)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.UNITY_PROJECT_PATH }}/Library
          key: Library-Android-${{ hashFiles('Unity project/Assets/**', 'Unity project/Packages/**', 'Unity project/ProjectSettings/**') }}
          restore-keys: |
            Library-Android-

      - name: Build Android APK
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.UNITY_PROJECT_PATH }}
          targetPlatform: Android
          buildName: Match3PAD

      - name: Upload Android Build
        uses: actions/upload-artifact@v4
        with:
          name: Android-Build
          path: build/Android
          retention-days: 14

  # Build for WebGL
  build-webgl:
    name: Build WebGL
    runs-on: ubuntu-latest
    needs: check-license
    if: |
      needs.check-license.outputs.has-license == 'true' &&
      (github.event_name != 'workflow_dispatch' || inputs.build_webgl)
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          lfs: true

      - name: Cache Unity Library
        uses: actions/cache@v4
        with:
          path: ${{ env.UNITY_PROJECT_PATH }}/Library
          key: Library-WebGL-${{ hashFiles('Unity project/Assets/**', 'Unity project/Packages/**', 'Unity project/ProjectSettings/**') }}
          restore-keys: |
            Library-WebGL-

      - name: Build WebGL
        uses: game-ci/unity-builder@v4
        env:
          UNITY_LICENSE: ${{ secrets.UNITY_LICENSE }}
          UNITY_EMAIL: ${{ secrets.UNITY_EMAIL }}
          UNITY_PASSWORD: ${{ secrets.UNITY_PASSWORD }}
        with:
          projectPath: ${{ env.UNITY_PROJECT_PATH }}
          targetPlatform: WebGL
          buildName: Match3PAD

      - name: Upload WebGL Build
        uses: actions/upload-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL
          retention-days: 14

  # Deploy WebGL to GitHub Pages (optional)
  deploy-webgl:
    name: Deploy to GitHub Pages
    runs-on: ubuntu-latest
    needs: build-webgl
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      pages: write
      id-token: write
    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}
    steps:
      - name: Download WebGL Build
        uses: actions/download-artifact@v4
        with:
          name: WebGL-Build
          path: build/WebGL

      - name: Setup Pages
        uses: actions/configure-pages@v4

      - name: Upload artifact
        uses: actions/upload-pages-artifact@v3
        with:
          path: build/WebGL/Match3PAD

      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4

  # Summary job
  build-summary:
    name: Build Summary
    runs-on: ubuntu-latest
    needs: [check-license, build-android, build-webgl]
    if: always()
    steps:
      - name: Summary
        run: |
          echo "## Unity Build Summary" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

          if [ "${{ needs.check-license.outputs.has-license }}" != "true" ]; then
            echo "⚠️ **Unity License not configured** - Builds were skipped" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "To enable builds, follow these steps:" >> $GITHUB_STEP_SUMMARY
            echo "1. Get your Unity license activation file from [GameCI Activation](https://game.ci/docs/github/activation)" >> $GITHUB_STEP_SUMMARY
            echo "2. Add the following secrets to your repository:" >> $GITHUB_STEP_SUMMARY
            echo "   - \`UNITY_LICENSE\` - Your Unity license file content" >> $GITHUB_STEP_SUMMARY
            echo "   - \`UNITY_EMAIL\` - Your Unity account email" >> $GITHUB_STEP_SUMMARY
            echo "   - \`UNITY_PASSWORD\` - Your Unity account password" >> $GITHUB_STEP_SUMMARY
          else
            echo "| Platform | Status |" >> $GITHUB_STEP_SUMMARY
            echo "|----------|--------|" >> $GITHUB_STEP_SUMMARY
            echo "| Android | ${{ needs.build-android.result == 'success' && '✅ Success' || needs.build-android.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
            echo "| WebGL | ${{ needs.build-webgl.result == 'success' && '✅ Success' || needs.build-webgl.result == 'skipped' && '⏭️ Skipped' || '❌ Failed' }} |" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Download Builds" >> $GITHUB_STEP_SUMMARY
          echo "Build artifacts are available in the Actions artifacts section." >> $GITHUB_STEP_SUMMARY
